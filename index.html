<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stock Dashboard Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            --bg-body: #0f172a; --bg-card: #1e293b; --bg-input: #334155; 
            --border-color: #334155; --text-main: #ffffff; --text-sub: #94a3b8;
            --chart-border: #0f172a; --input-text: #ffffff;
            --row-bg: #111827; --row-border: #1f2937;
            --btn-bg: #1e293b; --btn-text: #94a3b8;
        }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: -apple-system, sans-serif; }
        .chart-box { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color); padding: 15px; margin-bottom: 20px; position: relative; }
        .chart-container { height: 350px; position: relative; margin-bottom: 10px; }
        
        /* 橫排圖例樣式 */
        .color-legend-wrapper { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); }
        .legend-pill { display: flex; align-items: center; background: #1a2236; padding: 4px 10px; border-radius: 6px; font-size: 12px; color: #fff; border: 1px solid #334155; }
        .legend-color-box { width: 12px; height: 12px; border-radius: 3px; margin-right: 6px; }
        .legend-num { color: #94a3b8; margin-right: 4px; font-weight: bold; }

        .compact-row { background: var(--row-bg); border: 1px solid var(--row-border); margin-bottom: 6px; border-radius: 10px; display: flex; align-items: center; padding: 12px; }
        .input-field { background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 8px; padding: 8px; color: #fff; width: 100%; }
        .num-dot { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body class="p-3">

    <div class="max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-black text-blue-500 italic">DASHBOARD PRO</h2>
            <div class="flex gap-2">
                <button onclick="addNewChart()" class="bg-blue-600 text-white text-xs px-3 py-2 rounded-lg font-bold">+ 分組</button>
            </div>
        </header>

        <div id="masterChartWrapper" class="hidden">
            <div class="chart-box">
                <h3 class="text-center text-blue-400 font-bold mb-2">資產配置總覽</h3>
                <div class="chart-container"><canvas id="masterCanvas"></canvas></div>
                <div id="masterLegend" class="color-legend-wrapper"></div>
            </div>
        </div>

        <div id="chartsWrapper" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>

        <div class="chart-box">
            <input type="hidden" id="editId" value="">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                <input id="symbol" class="input-field" placeholder="代號">
                <input type="number" id="shares" class="input-field" placeholder="張數">
                <input type="number" id="avgPrice" class="input-field" placeholder="均價">
                <input id="note" class="input-field" placeholder="備註">
            </div>
            <button onclick="saveStock()" class="w-full bg-blue-600 py-3 rounded-xl font-bold">儲存並刷新</button>
        </div>

        <div id="mainTable" class="space-y-2 pb-24"></div>
    </div>

    <script>
        // 中文備註對照表
        const areaMapping = { 0: "台股現貨", 1: "美股/海外ETF", 2: "加密貨幣", 3: "現金/定存", 4: "其他資產", 5: "波段策略" };

        let myAssets = JSON.parse(localStorage.getItem('myAssetsV108')) || [];
        let chartConfigs = JSON.parse(localStorage.getItem('chartConfigsV108')) || [{ id: Date.now(), title: '主要配置', selectedIds: [] }];
        
        let chartInstances = {};
        let masterChartInstance = null;
        const palette = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316', '#14b8a6', '#fbbf24'];

        function render() {
            localStorage.setItem('myAssetsV108', JSON.stringify(myAssets));
            localStorage.setItem('chartConfigsV108', JSON.stringify(chartConfigs));

            // 1. 渲染總圖
            renderMasterChart();

            // 2. 渲染子圖容器
            const wrapper = document.getElementById('chartsWrapper');
            wrapper.innerHTML = chartConfigs.map((conf, i) => `
                <div class="chart-box">
                    <h4 class="text-center font-bold text-blue-400 text-sm">${conf.title}</h4>
                    <div class="chart-container"><canvas id="canvas-${i}"></canvas></div>
                    <div id="legend-${i}" class="color-legend-wrapper"></div>
                </div>
            `).join('');

            // 3. 渲染庫存列表
            const body = document.getElementById('mainTable');
            body.innerHTML = myAssets.map((item, index) => {
                const color = palette[index % palette.length];
                let activeNoteNames = [];
                let btns = chartConfigs.map((c, ci) => {
                    const active = c.selectedIds.includes(parseInt(item.id));
                    if(active) activeNoteNames.push(areaMapping[ci] || c.title);
                    return `<div onclick="toggleToChart(${item.id}, ${ci})" style="background:${active ? color : '#1f2937'}; color:${active ? '#fff' : '#94a3b8'}" class="num-dot mr-1">${ci+1}</div>`;
                }).join('');

                const areaTag = activeNoteNames.length > 0 ? `<span class="text-[10px] text-blue-400 ml-2 bg-blue-900/30 px-1 rounded">${activeNoteNames.join(', ')}</span>` : "";

                return `
                    <div class="compact-row">
                        <div class="w-1 h-6 rounded-full mr-3" style="background:${color}"></div>
                        <div class="flex-1 text-sm font-bold">${item.symbol}${areaTag}</div>
                        <div class="flex">${btns}</div>
                        <div class="ml-4 text-xs text-blue-500 cursor-pointer" onclick="editItem(${item.id})">改</div>
                    </div>`;
            }).join('');

            // 4. 啟動所有子圖表
            updateSubCharts();
        }

        function renderMasterChart() {
            const masterLabels = []; const masterData = []; const masterColors = [];
            chartConfigs.forEach((conf, i) => {
                let total = 0;
                conf.selectedIds.forEach(sid => {
                    const s = myAssets.find(a => a.id == sid);
                    if(s) total += (s.avgPrice * s.shares);
                });
                if(total > 0) {
                    masterLabels.push(conf.title);
                    masterData.push(total);
                    masterColors.push(palette[i % palette.length]);
                }
            });

            const wrapper = document.getElementById('masterChartWrapper');
            if(masterData.length > 0) {
                wrapper.classList.remove('hidden');
                const ctx = document.getElementById('masterCanvas').getContext('2d');
                if (masterChartInstance) masterChartInstance.destroy();
                masterChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: { labels: masterLabels, datasets: [{ data: masterData, backgroundColor: masterColors, borderWidth: 1 }]},
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { color: '#fff' } } }
                });
                document.getElementById('masterLegend').innerHTML = masterLabels.map((label, idx) => `
                    <div class="legend-pill">
                        <div class="legend-color-box" style="background:${masterColors[idx]}"></div>
                        <span class="legend-num">${idx + 1}.</span>
                        <span>${label} (${areaMapping[idx] || '未分類'})</span>
                    </div>`).join('');
            } else { wrapper.classList.add('hidden'); }
        }

        function updateSubCharts() {
            chartConfigs.forEach((conf, i) => {
                const canvas = document.getElementById(`canvas-${i}`);
                if(!canvas) return;
                const dData = []; const dLabels = []; const dColors = [];
                conf.selectedIds.forEach(sid => {
                    const idx = myAssets.findIndex(a => a.id == sid);
                    if(idx !== -1) {
                        dData.push(myAssets[idx].avgPrice * myAssets[idx].shares || 1);
                        dLabels.push(myAssets[idx].symbol);
                        dColors.push(palette[idx % palette.length]);
                    }
                });
                if (chartInstances[i]) chartInstances[i].destroy();
                chartInstances[i] = new Chart(canvas.getContext('2d'), {
                    type: 'pie',
                    data: { labels: dLabels, datasets: [{ data: dData, backgroundColor: dColors, borderWidth: 1 }]},
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { color: '#fff' } } }
                });
                document.getElementById(`legend-${i}`).innerHTML = dLabels.map((lab, idx) => `
                    <div class="legend-pill">
                        <div class="legend-color-box" style="background:${dColors[idx]}"></div>
                        <span class="legend-num">${idx + 1}.</span><span>${lab}</span>
                    </div>`).join('');
            });
        }

        function toggleToChart(sid, ci) {
            const arr = chartConfigs[ci].selectedIds;
            const idx = arr.indexOf(parseInt(sid));
            if (idx > -1) arr.splice(idx, 1); else arr.push(parseInt(sid));
            render();
        }

        function saveStock() {
            const sym = document.getElementById('symbol').value.trim();
            if(!sym) return;
            const data = { 
                id: document.getElementById('editId').value || Date.now(),
                symbol: sym.toUpperCase(),
                shares: parseFloat(document.getElementById('shares').value) || 0,
                avgPrice: parseFloat(document.getElementById('avgPrice').value) || 0,
                note: document.getElementById('note').value.trim() 
            };
            const existIdx = myAssets.findIndex(a => a.id == data.id);
            if(existIdx > -1) myAssets[existIdx] = data; else {
                myAssets.push(data);
                if(chartConfigs[0]) chartConfigs[0].selectedIds.push(data.id);
            }
            document.getElementById('editId').value = "";
            render();
        }

        function editItem(id) {
            const item = myAssets.find(a => a.id == id);
            document.getElementById('symbol').value = item.symbol;
            document.getElementById('shares').value = item.shares;
            document.getElementById('avgPrice').value = item.avgPrice;
            document.getElementById('editId').value = item.id;
        }

        function addNewChart() { const t = prompt("名稱"); if(t) { chartConfigs.push({id: Date.now(), title: t, selectedIds: []}); render(); } }

        window.onload = () => { Chart.register(ChartDataLabels); render(); };
    </script>
</body>
</html>
