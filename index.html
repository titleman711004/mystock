<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stock Dashboard Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            --bg-body: #0f172a; --bg-card: #1e293b; --bg-input: #334155; 
            --border-color: #334155; --text-main: #ffffff; --text-sub: #94a3b8;
            --chart-border: #0f172a; --input-text: #ffffff;
            --row-bg: #111827; --row-border: #1f2937;
            --tech-line: #06b6d4; --tech-text-pct: #06b6d4;
            --btn-bg: #1e293b; --btn-text: #94a3b8;
        }
        [data-theme="ocean"] { --bg-body: #0a1929; --bg-card: #132f4c; --bg-input: #1e4976; --border-color: #2a6496; --text-main: #e2e8f0; --text-sub: #94a3b8; --chart-border: #0a1929; --input-text: #ffffff; --row-bg: #0d2137; --row-border: #132f4c; --tech-line: #38bdf8; --tech-text-pct: #38bdf8; --btn-bg: #132f4c; --btn-text: #94a3b8; }
        [data-theme="oled"] { --bg-body: #000000; --bg-card: #121212; --bg-input: #262626; --border-color: #333333; --text-main: #e5e5e5; --text-sub: #a3a3a3; --chart-border: #000000; --input-text: #e5e5e5; --row-bg: #0a0a0a; --row-border: #262626; --tech-line: #22d3ee; --tech-text-pct: #22d3ee; --btn-bg: #171717; --btn-text: #a3a3a3; }

        body { background-color: var(--bg-body); color: var(--text-main); font-family: -apple-system, sans-serif; transition: background-color 0.3s, color 0.3s; }
        .input-card { background: var(--bg-card); border-radius: 12px; padding: 16px; border: 2px solid var(--border-color); margin-bottom: 20px; transition: 0.3s; }
        .input-field { background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; color: var(--input-text) !important; font-size: 16px !important; width: 100%; transition: all 0.3s; }
        .compact-row { background: var(--row-bg); border: 1px solid var(--row-border); margin-bottom: 8px; border-radius: 10px; display: flex; align-items: center; padding: 14px; min-height: 60px; transition: all 0.3s; }
        .drag-handle { cursor: move; color: #3b82f6; width: 40px; display: none; align-items: center; justify-content: center; font-size: 20px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; margin-right: 12px; }
        .sort-mode-active .drag-handle { display: flex; }
        .num-dot { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; border: 1px solid transparent; }
        
        .chart-box { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color); padding: 15px; margin-bottom: 12px; position: relative; transition: background-color 0.3s, border-color 0.3s; }
        .master-chart-box { border: 2px solid #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.15); }
        
        /* å¢åŠ  cursor pointer æç¤ºå¯é»æ“Š */
        .chart-container { height: 400px; position: relative; cursor: pointer; }
        .master-container { height: 480px; position: relative; cursor: pointer; }

        .note-legend { margin-top: 12px; border-top: 1px solid var(--border-color); padding-top: 12px; font-size: 13px; color: var(--text-sub); text-align: center; line-height: 1.6; }
        .screenshot-hide { opacity: 1; transition: opacity 0.2s; }
        .capturing .screenshot-hide { opacity: 0 !important; visibility: hidden !important; }

        .btn-icon { background: var(--btn-bg); color: var(--btn-text); border: 1px solid var(--border-color); }
        .btn-icon:hover { color: var(--text-main); border-color: var(--text-main); }
        
        /* ä¸‹æ–¹å°ç…§è¡¨æ¨£å¼ (åªåœ¨éç·¨è¼¯æ¨¡å¼é¡¯ç¤º) */
        .show-in-view-mode { display: none; }
        .note-legend { display: block; } /* é è¨­é¡¯ç¤º */

        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9999;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #3b82f6; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-3">

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div class="text-blue-400 font-bold tracking-widest">Processing...</div>
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row items-center justify-between mb-6 gap-y-4">
            <div class="flex flex-col items-center md:items-start w-full md:w-auto">
                <div class="flex items-center">
                    <h2 class="text-2xl font-black text-blue-500 italic text-center">DASHBOARD <span class="text-xs text-yellow-400 not-italic ml-1" style="text-shadow: 0 0 10px #facc15, 0 0 20px #854d0e;">PRO</span></h2>
                </div>
                <div class="flex items-center gap-3 mt-1">
                    <p class="text-[10px] text-white tracking-widest">Designed by Titleman</p>
                    <button onclick="cycleTheme()" class="text-xs px-2 py-0.5 rounded border border-slate-600 bg-slate-800 text-slate-300 hover:text-white transition-all whitespace-nowrap">
                        ğŸ¨ <span id="themeName">é è¨­</span>
                    </button>
                </div>
            </div>
            
            <div class="flex gap-3 justify-end w-full md:w-auto">
                <button onclick="addNewChart()" class="bg-blue-600 text-white text-[10px] px-4 py-2 rounded-lg font-bold whitespace-nowrap shadow-lg hover:scale-105 transition">+ åˆ†çµ„</button>
                <button onclick="copyToClipboard()" class="bg-emerald-700 text-white text-[10px] px-4 py-2 rounded-lg font-bold whitespace-nowrap shadow-lg hover:scale-105 transition">å‚™ä»½</button>
                <button onclick="importFromText()" class="bg-slate-700 text-white text-[10px] px-4 py-2 rounded-lg font-bold whitespace-nowrap shadow-lg hover:scale-105 transition">é‚„åŸ</button>
            </div>
        </header>

        <div id="masterChartWrapper" class="mb-8 hidden">
            <div class="chart-box master-chart-box" id="masterChartBox">
                <h3 class="text-center text-blue-400 font-bold text-xl mb-1 tracking-widest">è³‡ç”¢é…ç½®ç¸½è¦½</h3>
                <div class="text-center text-slate-500 text-xs mb-2 font-mono tracking-wider">
                    ç¸½è³‡ç”¢ï¼š<span id="grandTotal" class="text-emerald-400 font-black text-2xl">0</span> è¬
                </div>
                
                <button onclick="downloadMasterChart()" class="screenshot-hide absolute top-3 right-3 btn-icon transition-colors rounded-full w-8 h-8 flex items-center justify-center" title="å¦é–‹é«˜ç•«è³ªåœ–æª”">
                    ğŸ“·
                </button>

                <div class="master-container">
                    <canvas id="masterCanvas"></canvas>
                </div>
            </div>
        </div>

        <div id="chartsWrapper" class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6"></div>

        <div id="inputArea" class="input-card shadow-2xl">
            <input type="hidden" id="editId" value="">
            <div class="grid grid-cols-2 md:grid-cols-7 gap-3 mb-4">
                <div class="col-span-1"><label class="text-[10px] text-slate-400 mb-1 block">è‚¡ç¥¨ä»£è™Ÿ</label><input id="symbol" class="input-field"></div>
                <div class="col-span-1"><label class="text-[10px] text-blue-400 mb-1 block">æ–‡å­—å¤§å°</label><input type="number" id="fontSize" class="input-field" value="12"></div>
                <div class="col-span-1"><label class="text-[10px] text-slate-400 mb-1 block">å¼µæ•¸</label><input type="number" id="shares" class="input-field" step="0.001"></div>
                <div class="col-span-1"><label class="text-[10px] text-slate-400 mb-1 block">å‡åƒ¹</label><input type="number" id="avgPrice" class="input-field"></div>
                <div class="col-span-1"><label class="text-[10px] text-emerald-400 mb-1 block">é ˜æ¯</label><input type="number" id="divRec" value="0" class="input-field"></div>
                <div class="col-span-1"><label class="text-[10px] text-orange-400 mb-1 block">ç²åˆ©</label><input type="number" id="gainRec" value="0" class="input-field"></div>
                <div class="col-span-2 md:col-span-7"><label class="text-[10px] text-yellow-500 mb-1 block">å‚™è¨» (ç½®ä¸­æ–¼åœ–è¡¨ä¸‹æ–¹)</label><input id="note" class="input-field"></div>
            </div>
            <button onclick="saveStock()" class="w-full bg-blue-600 py-4 rounded-xl font-black text-xl active:scale-95 transition-all">å„²å­˜ä¸¦åˆ·æ–°</button>
        </div>

        <div class="flex justify-between items-center mb-4 px-1">
            <span class="text-sm font-bold text-slate-500 uppercase tracking-widest">è³‡ç”¢åˆ—è¡¨</span>
            <button id="sortToggle" onclick="toggleSortMode()" class="text-xs bg-slate-800 border border-slate-600 px-5 py-2 rounded-full text-blue-400 font-bold">â‡… æ’åºæ¨¡å¼</button>
        </div>

        <div id="mainTable" class="space-y-2 pb-24"></div>
    </div>
    
    <footer class="text-center text-slate-600 text-[10px] mt-8 py-6 border-t border-slate-800 tracking-wider">
        Copyright Â© Titleman
    </footer>
    
    <script>
        function loadRobustData(currentKey, fallbackKeys, defaultValue) {
            let data = localStorage.getItem(currentKey);
            if (data && data !== "[]" && data !== "null") return JSON.parse(data);
            for (let key of fallbackKeys) {
                let oldData = localStorage.getItem(key);
                if (oldData && oldData !== "[]" && oldData !== "null") {
                    localStorage.setItem(currentKey, oldData);
                    return JSON.parse(oldData);
                }
            }
            return defaultValue;
        }

        // ä½¿ç”¨æœ€æ–°çš„ Keyï¼Œä½†ä¿ç•™å‘ä¸‹ç›¸å®¹
        const assetKeys = ['myAssetsV112', 'myAssetsV106', 'myAssets']; 
        const configKeys = ['chartConfigsV112', 'chartConfigsV108', 'chartConfigs'];

        let myAssets = loadRobustData('myAssetsV112', assetKeys, []);
        let chartConfigs = loadRobustData('chartConfigsV112', configKeys, [{ id: Date.now(), title: 'ä¸»è¦é…ç½®', selectedIds: [], labelPos: 'inside', labelContent: 'symbol' }]);
        
        // --- é—œéµï¼šè³‡æ–™è‡ªå‹•ä¿®å¾© (Auto-Fix) ---
        // ç¢ºä¿èˆŠå‚™ä»½æª”è®€å…¥å¾Œï¼Œæœ‰ 'labelPos' å’Œ 'labelContent' å±¬æ€§
        chartConfigs.forEach(c => {
            if (!c.selectedIds) c.selectedIds = [];
            // å¼·åˆ¶å°‡é è¨­ä½ç½®æ”¹ç‚º 'inside'
            if (!c.labelPos || c.labelPos === 'outside') c.labelPos = 'inside';
            // é è¨­å…§å®¹ç‚º 'symbol' (ä»£è™Ÿ)
            if (!c.labelContent) c.labelContent = 'symbol'; 
        });

        let masterLabelPos = localStorage.getItem('masterLabelPosV1') || 'inside';
        let currentTheme = localStorage.getItem('appThemeV1') || 'dark';
        
        let chartInstances = {};
        let masterChartInstance = null;
        let isSortMode = false;
        let sortable = null;

        const uniquePalette = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316', '#14b8a6', '#fbbf24', '#6366f1', '#d946ef', '#2dd4bf', '#f43f5e', '#a855f7', '#34d399', '#fb7185', '#60a5fa', '#fb923c', '#818cf8'];
        function getItemColor(index) { return uniquePalette[index % uniquePalette.length]; }

        function getThemeColor(varName) {
            return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        }

        // æ–°å¢ï¼šé»æ“Šåœ–è¡¨åˆ‡æ›é¡¯ç¤ºå…§å®¹ (ä»£è™Ÿ <-> ä¸­æ–‡)
        function toggleChartLabelContent(index) {
            // ä½¿ç”¨ setTimeout ç¢ºä¿é»æ“Šäº‹ä»¶çµæŸå¾Œæ‰é‡ç¹ªï¼Œé˜²æ­¢åœ–è¡¨æ¶ˆå¤±
            setTimeout(() => {
                const current = chartConfigs[index].labelContent || 'symbol';
                chartConfigs[index].labelContent = (current === 'symbol') ? 'note' : 'symbol';
                render();
            }, 50);
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const names = { 'dark': 'é è¨­', 'ocean': 'æµ·æ´‹', 'oled': 'OLED' };
            document.getElementById('themeName').innerText = names[theme];
            localStorage.setItem('appThemeV1', theme);
            currentTheme = theme;
            render(); 
        }

        function cycleTheme() {
            const order = ['dark', 'ocean', 'oled'];
            const nextIndex = (order.indexOf(currentTheme) + 1) % order.length;
            applyTheme(order[nextIndex]);
        }

        function render() {
            localStorage.setItem('myAssetsV112', JSON.stringify(myAssets));
            localStorage.setItem('chartConfigsV112', JSON.stringify(chartConfigs));
            localStorage.setItem('masterLabelPosV1', masterLabelPos);

            if(!document.documentElement.getAttribute('data-theme')) applyTheme(currentTheme);

            // âš ï¸ é‡ç¹ªå‰å…ˆéŠ·æ¯€èˆŠåœ–è¡¨ï¼Œé¿å…æ®˜ç•™
            if (masterChartInstance) { masterChartInstance.destroy(); masterChartInstance = null; }
            Object.values(chartInstances).forEach(chart => chart.destroy());
            chartInstances = {};

            const chartBorderColor = getThemeColor('--chart-border');
            const textColor = getThemeColor('--text-main');
            const isMobile = window.innerWidth < 480;

            const masterLabels = [];
            const masterData = [];
            const masterColors = [];
            let grandTotal = 0;

            chartConfigs.forEach((conf, i) => {
                let groupTotal = 0;
                conf.selectedIds.forEach(sid => {
                    const s = myAssets.find(a => a.id == sid);
                    if(s) {
                        const netCost = (s.avgPrice * s.shares * 1000) - (s.divRec || 0) - (s.gainRec || 0);
                        groupTotal += (netCost > 0 ? netCost : 0);
                    }
                });
                if(groupTotal > 0) {
                    masterLabels.push(conf.title);
                    masterData.push(groupTotal);
                    masterColors.push(getItemColor(i)); 
                    grandTotal += groupTotal;
                }
            });

            document.getElementById('grandTotal').innerText = (grandTotal / 10000).toFixed(1);
            
            const masterWrapper = document.getElementById('masterChartWrapper');
            if(grandTotal > 0) {
                masterWrapper.classList.remove('hidden');
                const ctxM = document.getElementById('masterCanvas').getContext('2d');
                
                masterChartInstance = new Chart(ctxM, {
                    type: 'pie',
                    data: { labels: masterLabels, datasets: [{ data: masterData, backgroundColor: masterColors, borderWidth: 2, borderColor: chartBorderColor }]},
                    options: {
                        devicePixelRatio: 3,
                        responsive: true, maintainAspectRatio: false, 
                        radius: isMobile ? '50%' : '90%', 
                        layout: { 
                            // å¼·åˆ¶ paddingï¼Œç¢ºä¿æœ‰ç©ºé–“
                            padding: { top: 50, bottom: 20, left: 20, right: 20 }
                        },
                        plugins: {
                            legend: { display: false }, // Master ä¹Ÿä¸é¡¯ç¤ºå¤–åœ Legendï¼Œä¿æŒä¹¾æ·¨
                            datalabels: { 
                                display: true, // Master å¼·åˆ¶é¡¯ç¤º
                                color: (ctx) => '#ffffff', 
                                textAlign: 'center',
                                font: { weight: 'bold', size: 13 },
                                formatter: (val, ctx) => {
                                    const percent = ((val / grandTotal) * 100).toFixed(1) + '%';
                                    return ctx.chart.data.labels[ctx.dataIndex] + '\n' + percent;
                                }
                            }
                        }
                    }
                });
            } else {
                masterWrapper.classList.add('hidden');
            }

            const wrapper = document.getElementById('chartsWrapper');
            wrapper.innerHTML = '';
            chartConfigs.forEach((conf, i) => {
                const noteItems = conf.selectedIds.map(sid => myAssets.find(a => a.id == sid)).filter(a => a && a.note);
                // å°ç…§è¡¨é¡¯ç¤ºï¼šé¡è‰²é» + ä»£è™Ÿ + å‚™è¨»
                let notesHtml = noteItems.map(a => {
                    const color = getItemColor(myAssets.findIndex(ma => ma.id === a.id));
                    return `<div class="flex items-center gap-2 mb-1">
                                <div style="width:8px;height:8px;border-radius:50%;background:${color}"></div>
                                <span class="font-bold text-white">${a.symbol}</span>
                                <span class="text-slate-400 text-xs">${a.note}</span>
                            </div>`;
                }).join('');

                let totalCost = 0;
                conf.selectedIds.forEach(sid => {
                    const a = myAssets.find(item => item.id == sid);
                    if (a) {
                        const cost = (a.avgPrice * a.shares * 1000) - (a.divRec || 0) - (a.gainRec || 0);
                        totalCost += cost;
                    }
                });
                const totalWan = (totalCost / 10000).toFixed(1);

                wrapper.innerHTML += `
                    <div class="chart-box" id="chart-box-${i}">
                        <input type="text" onchange="chartConfigs[${i}].title=this.value;render()" value="${conf.title}" class="bg-transparent border-none font-bold text-blue-400 text-center w-full mb-1 text-lg">
                        <div class="text-center text-slate-500 text-xs mb-2 font-mono tracking-wider">
                            å¸‚å€¼ï¼š<span class="text-emerald-400 font-black text-base">${totalWan}</span> è¬
                        </div>
                        
                        <button onclick="downloadChart(${i})" class="screenshot-hide absolute top-3 right-2 btn-icon transition-colors rounded-full w-8 h-8 flex items-center justify-center" title="å¦é–‹é«˜ç•«è³ªåœ–æª”">ğŸ“·</button>
                        <button onclick="deleteChart(${i})" class="screenshot-hide absolute top-3 left-3 btn-icon transition-colors rounded-full w-8 h-8 flex items-center justify-center" title="åˆªé™¤åˆ†çµ„">âœ•</button>
                        
                        <div class="chart-container" onclick="toggleChartLabelContent(${i})" title="é»æ“Šåœ–è¡¨åˆ‡æ›é¡¯ç¤ºä»£è™Ÿ/ä¸­æ–‡">
                            <canvas id="canvas-${i}"></canvas>
                        </div>
                        
                        <div class="note-legend text-left px-4">
                            ${notesHtml || '<div class="text-center opacity-20">ç„¡å‚™è¨»</div>'}
                        </div>
                    </div>`;
            });
            
            const body = document.getElementById('mainTable');
            body.innerHTML = '';
            myAssets.forEach((item, index) => {
                const stockColor = getItemColor(index);
                let btns = '';
                chartConfigs.forEach((c, ci) => {
                    const active = c.selectedIds.includes(parseInt(item.id));
                    const style = active ? `background:${stockColor}; border-color:${stockColor}; color:white;` : `background:var(--row-border); border-color:var(--border-color); color:var(--text-sub);`;
                    btns += `<div onclick="event.stopPropagation(); toggleToChart(${item.id}, ${ci})" style="${style}" class="num-dot">${ci+1}</div>`;
                });

                body.innerHTML += `
                    <div class="compact-row" data-id="${item.id}">
                        <div class="drag-handle">â˜°</div>
                        <div class="w-1.5 h-7 rounded-full mr-3" style="background:${stockColor}"></div>
                        <div class="flex-1 text-sm">
                            <span class="font-bold">${item.symbol}</span>
                            <span class="text-slate-500 text-xs ml-2">${item.shares}å¼µ</span>
                        </div>
                        <div class="flex gap-1 ml-2">${btns}</div>
                        <div class="flex gap-4 ml-4">
                            <span onclick="editItem(${item.id})" class="text-blue-500 font-bold text-xs cursor-pointer">æ”¹</span>
                            <span onclick="deleteItem(${item.id})" class="text-slate-700 text-xs cursor-pointer">âœ•</span>
                        </div>
                    </div>`;
            });
            if(isSortMode) initSortable();
            updateCharts();
        }

        function updateCharts() {
            const chartBorderColor = getThemeColor('--chart-border');
            const isMobile = window.innerWidth < 480; 
            chartConfigs.forEach((conf, i) => {
                const canvas = document.getElementById(`canvas-${i}`);
                if(!canvas) return;
                const ctx = canvas.getContext('2d');
                const dData = [], dLabels = [], dColors = [], dShares = [], dFontSizes = [];
                conf.selectedIds.forEach(sid => {
                    const idx = myAssets.findIndex(a => a.id == sid);
                    if(idx !== -1) {
                        const s = myAssets[idx];
                        const netCost = (s.avgPrice * s.shares * 1000) - (s.divRec || 0) - (s.gainRec || 0);
                        dData.push(netCost > 0 ? netCost : 1);
                        
                        // --- æ ¸å¿ƒä¿®æ”¹ï¼šä¾æ“šè¨­å®šé¡¯ç¤º æ–‡å­— ---
                        let labelText = s.symbol;
                        // å¦‚æœè©²åœ–è¡¨è¨­å®šç‚º note æ¨¡å¼ä¸”æœ‰å¡«å¯« note
                        if (conf.labelContent === 'note' && s.note) {
                            labelText = s.note;
                        }
                        dLabels.push(labelText);
                        
                        dShares.push(s.shares); 
                        dColors.push(getItemColor(idx)); 
                        dFontSizes.push(s.fontSize || 12);
                    }
                });
                
                chartInstances[i] = new Chart(ctx, {
                    type: 'pie',
                    data: { labels: dLabels, datasets: [{ data: dData, backgroundColor: dColors, borderWidth: 1, borderColor: chartBorderColor }]},
                    options: {
                        // ç§»é™¤ Chart.js é è¨­çš„ onClickï¼Œé¿å…å¹²æ“¾å¤–å±¤ div çš„é»æ“Š
                        onClick: null, 
                        devicePixelRatio: 3, responsive: true, maintainAspectRatio: false, 
                        radius: isMobile ? '50%' : '90%', 
                        layout: { 
                            // å¼·åˆ¶ paddingï¼Œé¿å…æ–‡å­—è¢«åˆ‡æ‰
                            padding: { top: 30, bottom: 20, left: 20, right: 20 }
                        },
                        plugins: {
                            legend: { display: false }, // å¼·åˆ¶ä¸é¡¯ç¤ºå‘¨åœæ¨™ç±¤
                            datalabels: {
                                // å¼·åˆ¶é¡¯ç¤ºåœ¨å…§éƒ¨ (Inside)
                                color: (ctx) => '#ffffff', 
                                textAlign: 'center', 
                                display: true, 
                                anchor: 'center', 
                                align: 'center', 
                                offset: 0, 
                                font: (ctx) => ({ weight: 'bold', size: dFontSizes[ctx.dataIndex] }), 
                                formatter: (val, ctx) => ctx.chart.data.labels[ctx.dataIndex] + '\n' + dShares[ctx.dataIndex] + 'å¼µ'
                            }
                        }
                    },
                    plugins: [] // ä¸ä½¿ç”¨ techLabelsPlugin (ç§»é™¤å¤–éƒ¨å¼•å°ç·š)
                });
            });
        }

        function toggleToChart(sid, ci) { 
            if (!chartConfigs[ci]) return;
            if (!chartConfigs[ci].selectedIds) chartConfigs[ci].selectedIds = [];
            const arr = chartConfigs[ci].selectedIds;
            const id = parseInt(sid);
            const i = arr.indexOf(id); 
            if (i > -1) arr.splice(i, 1); 
            else arr.push(id); 
            render(); 
        }

        function toggleMasterLabelPos() { masterLabelPos = (masterLabelPos === 'outside') ? 'inside' : 'outside'; render(); }
        function downloadMasterChart() { const el = document.getElementById('masterChartBox'); const total = document.getElementById('grandTotal').innerText; captureAndOpenImage(el, `è³‡ç”¢ç¸½è¦½_ç¸½å€¼${total}è¬`); }
        function downloadChart(index) { const el = document.getElementById(`chart-box-${index}`); const title = chartConfigs[index].title || 'chart'; const val = (el.innerText.match(/å¸‚å€¼ï¼š([\d\.]+) è¬/) || [])[1] || ''; captureAndOpenImage(el, `${title}_å¸‚å€¼${val}è¬`); }

        function captureAndOpenImage(element, fileName) {
            const loading = document.getElementById('loadingOverlay'); loading.style.display = 'flex'; element.classList.add('capturing'); const originalBg = element.style.backgroundColor; element.style.backgroundColor = getThemeColor('--bg-card');
            setTimeout(() => {
                html2canvas(element, { scale: 5, backgroundColor: getThemeColor('--bg-card'), useCORS: true, logging: false, allowTaint: true, onclone: (clonedDoc) => { const clonedEl = clonedDoc.getElementById(element.id); if(clonedEl) clonedEl.style.transform = 'none'; } }).then(canvas => {
                    loading.style.display = 'none'; element.classList.remove('capturing'); element.style.backgroundColor = originalBg; 
                    const jpgUrl = canvas.toDataURL('image/jpeg', 1.0); const newWin = window.open('', '_blank');
                    if (newWin) { newWin.document.write(`<html><head><title>${fileName}</title><style>body{margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background-color:#111}img{max-width:95%;height:auto;box-shadow:0 0 20px rgba(0,0,0,0.5);border-radius:12px}.tip{position:fixed;top:10px;left:50%;transform:translateX(-50%);color:#fff;background:rgba(0,0,0,0.7);padding:8px 16px;border-radius:20px;font-family:sans-serif;font-size:14px}</style></head><body><div class="tip">è«‹é•·æŒ‰åœ–ç‰‡å¦å­˜æ–°æª”</div><img src="${jpgUrl}"></body></html>`); newWin.document.close(); } else { alert('è«‹å…è¨±å½ˆå‡ºè¦–çª—'); }
                }).catch(err => { console.error(err); loading.style.display = 'none'; element.classList.remove('capturing'); element.style.backgroundColor = originalBg; alert("å¤±æ•—"); });
            }, 100);
        }

        // ä¿ç•™åŸæœ‰çš„ Prompt é‚„åŸæ–¹å¼ï¼Œç¢ºä¿ç›¸å®¹æ€§
        function copyToClipboard() { const d = btoa(encodeURIComponent(JSON.stringify({myAssets, chartConfigs}))); const textArea = document.createElement("textarea"); textArea.value = d; textArea.style.position = "fixed"; textArea.style.left = "-9999px"; textArea.style.top = "0"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { const successful = document.execCommand('copy'); if ( successful) alert("å‚™ä»½å·²è¤‡è£½ï¼"); else prompt("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ä»£ç¢¼ï¼š", d); } catch (err) { console.error('Fallback', err); prompt("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ä»£ç¢¼ï¼š", d); } document.body.removeChild(textArea); }
        function importFromText() { const c = prompt("ä»£ç¢¼ï¼š"); if(c) { try { const d = JSON.parse(decodeURIComponent(atob(c))); myAssets=d.myAssets; chartConfigs=d.chartConfigs; render(); } catch(e){ alert("éŒ¯èª¤"); } } }
        
        function toggleSortMode() { isSortMode = !isSortMode; const btn = document.getElementById('sortToggle'); const table = document.getElementById('mainTable'); if(isSortMode) { btn.innerText = "âœ“ é–å®šé †åº"; table.classList.add('sort-mode-active'); initSortable(); } else { btn.innerText = "â‡… æ’åºæ¨¡å¼"; table.classList.remove('sort-mode-active'); if (sortable) sortable.destroy(); } }
        function initSortable() { const el = document.getElementById('mainTable'); if (sortable) sortable.destroy(); sortable = Sortable.create(el, { handle: '.drag-handle', animation: 200, onEnd: () => { const newOrder = Array.from(el.querySelectorAll('.compact-row')).map(r => parseInt(r.dataset.id)); myAssets = newOrder.map(id => myAssets.find(a => a.id === id)); render(); } }); }
        
        function saveStock() {
            const sym = document.getElementById('symbol').value.trim();
            if(!sym) return;
            const editId = document.getElementById('editId').value;
            const data = { id: editId ? parseInt(editId) : Date.now(), symbol: sym.toUpperCase(), fontSize: parseInt(document.getElementById('fontSize').value) || 12, shares: parseFloat(document.getElementById('shares').value) || 0, avgPrice: parseFloat(document.getElementById('avgPrice').value) || 0, divRec: parseFloat(document.getElementById('divRec').value) || 0, gainRec: parseFloat(document.getElementById('gainRec').value) || 0, note: document.getElementById('note').value.trim() };
            if (editId) { myAssets[myAssets.findIndex(i => i.id == editId)] = data; } else { myAssets.push(data); if (chartConfigs.length > 0) { if (!chartConfigs[0].selectedIds) chartConfigs[0].selectedIds = []; chartConfigs[0].selectedIds.push(data.id); } }
            ["editId", "symbol", "shares", "avgPrice", "divRec", "gainRec", "note"].forEach(id => document.getElementById(id).value = (id.includes('Rec') ? 0 : ""));
            document.getElementById('fontSize').value = 12;
            render();
        }

        function editItem(id) {
            const item = myAssets.find(i => i.id == id);
            ["symbol", "fontSize", "shares", "avgPrice", "divRec", "gainRec", "note"].forEach(k => document.getElementById(k).value = item[k] || (k.includes('Rec') ? 0 : ""));
            document.getElementById('editId').value = item.id;
            document.getElementById('inputArea').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function addNewChart() { const t = prompt("çµ„åˆ¥åç¨±ï¼š"); if (t) { chartConfigs.push({ id: Date.now(), title: t, selectedIds: [], labelPos: 'inside' }); render(); } }
        function deleteChart(idx) { if (confirm("åˆªé™¤ï¼Ÿ")) { chartConfigs.splice(idx, 1); render(); } }
        function deleteItem(id) { if(confirm("åˆªé™¤ï¼Ÿ")) { myAssets = myAssets.filter(i => i.id !== id); render(); } }
        
        window.onload = () => { Chart.register(ChartDataLabels); render(); };
    </script>
</body>
</html>
