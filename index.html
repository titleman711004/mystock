<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stock Dashboard Pro</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Roboto:wght@500;700;900&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            --bg-body: #0f172a; --bg-card: #1e293b; --bg-input: #334155; 
            --border-color: #334155; --text-main: #ffffff; --text-sub: #94a3b8;
            --chart-border: #0f172a; --input-text: #ffffff;
            --row-bg: #111827; --row-border: #1f2937;
            --tech-line: #06b6d4; --tech-text-pct: #06b6d4;
            --btn-bg: #1e293b; --btn-text: #94a3b8;
            --font-main: 'Noto Sans TC', sans-serif;
            --font-num: 'Roboto', sans-serif;
        }
        [data-theme="oled"] { --bg-body: #000000; --bg-card: #121212; --bg-input: #262626; --border-color: #333333; --text-main: #e5e5e5; --text-sub: #a3a3a3; --chart-border: #000000; --input-text: #e5e5e5; --row-bg: #0a0a0a; --row-border: #262626; --tech-line: #22d3ee; --tech-text-pct: #22d3ee; --btn-bg: #171717; --btn-text: #a3a3a3; }
        [data-theme="tiffany"] { --bg-body: #042f2e; --bg-card: #115e59; --bg-input: #134e4a; --border-color: #2dd4bf; --text-main: #f0fdfa; --text-sub: #99f6e4; --chart-border: #042f2e; --input-text: #ccfbf1; --row-bg: #022c22; --row-border: #115e59; --tech-line: #5eead4; --tech-text-pct: #5eead4; --btn-bg: #134e4a; --btn-text: #99f6e4; }
        [data-theme="green"] { --bg-body: #052e16; --bg-card: #14532d; --bg-input: #166534; --border-color: #22c55e; --text-main: #f0fdf4; --text-sub: #86efac; --chart-border: #052e16; --input-text: #dcfce7; --row-bg: #022c22; --row-border: #14532d; --tech-line: #4ade80; --tech-text-pct: #4ade80; --btn-bg: #14532d; --btn-text: #86efac; }
        [data-theme="yellow"] { --bg-body: #1a1602; --bg-card: #3f3204; --bg-input: #574608; --border-color: #eab308; --text-main: #fefce8; --text-sub: #fde047; --chart-border: #1a1602; --input-text: #fef08a; --row-bg: #151201; --row-border: #422006; --tech-line: #facc15; --tech-text-pct: #facc15; --btn-bg: #3f3204; --btn-text: #fde047; }
        [data-theme="orange"] { --bg-body: #1f0b03; --bg-card: #431407; --bg-input: #7c2d12; --border-color: #f97316; --text-main: #fff7ed; --text-sub: #fdba74; --chart-border: #1f0b03; --input-text: #ffedd5; --row-bg: #180802; --row-border: #561d0d; --tech-line: #fb923c; --tech-text-pct: #fb923c; --btn-bg: #431407; --btn-text: #fdba74; }
        [data-theme="purple"] { --bg-body: #180326; --bg-card: #3b0764; --bg-input: #581c87; --border-color: #a855f7; --text-main: #faf5ff; --text-sub: #d8b4fe; --chart-border: #180326; --input-text: #f3e8ff; --row-bg: #12021d; --row-border: #4a0d75; --tech-line: #c084fc; --tech-text-pct: #c084fc; --btn-bg: #3b0764; --btn-text: #d8b4fe; }

        body { background-color: var(--bg-body); color: var(--text-main); font-family: var(--font-main); transition: background-color 0.3s, color 0.3s; letter-spacing: 0.02em; }
        .input-card { background: var(--bg-card); border-radius: 12px; padding: 16px; border: 2px solid var(--border-color); margin-bottom: 20px; transition: 0.3s; }
        .input-field { background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; color: var(--input-text) !important; font-size: 16px !important; width: 100%; transition: all 0.3s; font-family: var(--font-main); }
        .compact-row { background: var(--row-bg); border: 1px solid var(--row-border); margin-bottom: 8px; border-radius: 10px; display: flex; align-items: center; padding: 14px; min-height: 60px; transition: all 0.3s; flex-wrap: wrap; }
        .drag-handle { cursor: move; color: #3b82f6; width: 40px; display: none; align-items: center; justify-content: center; font-size: 20px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; margin-right: 12px; }
        .sort-mode-active .drag-handle { display: flex; }
        .num-dot { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; border: 1px solid transparent; }
        
        .chart-box { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color); padding: 15px; margin-bottom: 12px; position: relative; transition: background-color 0.3s, border-color 0.3s; padding-top: 40px; }
        .master-chart-box { border: 2px solid #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.15); padding-top: 15px; }
        
        .chart-container { height: 400px; min-height: 400px; position: relative; width: 100%; cursor: pointer; }
        .master-container { height: 480px; min-height: 480px; position: relative; width: 100%; cursor: pointer; }

        .note-legend { margin-top: 12px; border-top: 1px solid var(--border-color); padding-top: 12px; font-size: 13px; color: var(--text-sub); text-align: center; line-height: 1.6; }
        .screenshot-hide { opacity: 1; transition: opacity 0.2s; }
        .capturing .screenshot-hide { opacity: 0 !important; visibility: hidden !important; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-icon { background: var(--btn-bg); color: var(--btn-text); border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .btn-icon:hover { color: var(--text-main); border-color: var(--text-main); background: var(--border-color); transform: scale(1.05); }
        .btn-toolbar-group { display: flex; gap: 6px; position: absolute; top: 12px; right: 12px; z-index: 10; }
        .btn-delete-pos { position: absolute; top: 12px; left: 12px; z-index: 10; }
        
        /* è¼‰å…¥å‹•ç•« */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9999;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #3b82f6; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* é‚„åŸè³‡æ–™é¢æ¿ */
        #importModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9998;
            display: none; justify-content: center; align-items: center; flex-direction: column; padding: 20px;
        }

        select.input-field { -webkit-appearance: none; appearance: none; }
        .hidden-in-view-mode { display: block; }
        .view-mode-active .hidden-in-view-mode { display: none !important; }
        .show-in-view-mode { display: none; }
        .view-mode-active .show-in-view-mode { display: block !important; }

        .title-input { border: none; border-bottom: 1px dashed var(--border-color); border-radius: 0; background: transparent; }
        .title-input:focus { border-bottom: 1px solid var(--text-main); outline: none; }

        .text-gain { color: #f87171; } 
        .text-loss { color: #4ade80; }
        .stock-name-display { font-size: 14px; font-weight: 500; color: var(--text-sub); margin-left: 6px; }
    </style>
</head>
<body class="p-3">

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div class="text-blue-400 font-bold tracking-widest" id="loadingText">Processing...</div>
    </div>

    <div id="importModal">
        <h3 class="text-white font-bold text-xl mb-4">é‚„åŸå‚™ä»½è³‡æ–™</h3>
        <p class="text-slate-400 text-xs mb-2 text-center">è«‹å°‡ä»£ç¢¼ (JTdC é–‹é ­) è²¼åœ¨ä¸‹æ–¹ï¼Œç³»çµ±æœƒè‡ªå‹•ä¿®å¾©æ ¼å¼ï¼š</p>
        <textarea id="importTextarea" class="w-full max-w-2xl h-48 bg-slate-800 text-white p-4 rounded-xl border border-slate-600 mb-4 text-xs font-mono focus:outline-none focus:border-blue-500" placeholder="åœ¨æ­¤è²¼ä¸Šä»£ç¢¼..."></textarea>
        <div class="flex gap-4 w-full max-w-2xl">
            <button onclick="confirmImport()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold transition">ç¢ºèªé‚„åŸ</button>
            <button onclick="closeImportModal()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-lg font-bold transition">å–æ¶ˆ</button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row items-center justify-between mb-6 gap-y-4">
            <div class="flex flex-col items-center md:items-start w-full md:w-auto">
                <div class="flex items-center">
                    <h2 class="text-3xl font-black text-blue-500 italic text-center tracking-tighter">DASHBOARD <span class="text-xs text-yellow-400 not-italic ml-1 font-bold" style="text-shadow: 0 0 10px #facc15, 0 0 20px #854d0e;">PRO</span></h2>
                </div>
                <div class="flex items-center gap-1 mt-1 flex-wrap">
                    <p class="text-[10px] text-white tracking-widest font-medium mr-1">Designed by Titleman</p>
                    <button onclick="cycleTheme()" class="text-xs px-2 py-0.5 rounded border border-slate-600 bg-slate-800 text-slate-300 hover:text-white transition-all whitespace-nowrap font-medium hidden-in-view-mode">
                        <span id="themeName">é è¨­</span>
                    </button>
                    <button onclick="toggleEditMode()" id="modeBtn" class="text-xs px-2 py-0.5 rounded border border-blue-600 bg-blue-900 text-blue-200 hover:text-white transition-all whitespace-nowrap font-medium">
                        âœï¸ ç·¨è¼¯
                    </button>
                </div>
            </div>
            
            <div class="flex gap-3 justify-end w-full md:w-auto items-center flex-wrap">
                <button onclick="updateAllPrices()" class="bg-amber-600 text-white text-[10px] px-4 py-2 rounded-lg font-bold whitespace-nowrap shadow-lg hover:scale-105 transition tracking-wide flex items-center gap-1">
                    <span>â†»</span> æ›´æ–°è‚¡åƒ¹
                </button>
                <button onclick="addNewChart()" class="bg-blue-600 text-white text-[10px] px-4 py-2 rounded-lg font-bold whitespace-nowrap shadow-lg hover:scale-105 transition tracking-wide hidden-in-view-mode">+ åˆ†çµ„</button>
                <button onclick="copyToClipboard()" class="bg-emerald-700 text-white text-[10px] px-4 py-2 rounded-lg font-bold whitespace-nowrap shadow-lg hover:scale-105 transition tracking-wide hidden-in-view-mode">å‚™ä»½</button>
                <button onclick="openImportModal()" class="bg-slate-700 text-white text-[10px] px-4 py-2 rounded-lg font-bold whitespace-nowrap shadow-lg hover:scale-105 transition tracking-wide hidden-in-view-mode">é‚„åŸ</button>
            </div>
        </header>

        <div id="masterChartWrapper" class="mb-8 hidden">
            <div class="chart-box master-chart-box" id="masterChartBox">
                <h3 class="text-center text-blue-400 font-bold text-xl mb-1 tracking-widest">è³‡ç”¢é…ç½®ç¸½è¦½</h3>
                <div class="text-center text-emerald-500 text-m mb-3 font-mono tracking-wider font-medium">
                    ç¸½è³‡ç”¢ ï¼š<span id="grandTotal" class="text-red-400 font-black text-2xl font-num">0</span> è¬
                </div>
                <div class="grid grid-cols-3 gap-2 mt-2 mb-2 px-2 max-w-2xl mx-auto">
                    <div class="text-center p-2 bg-slate-800/50 rounded-lg border border-slate-700/50 backdrop-blur-sm">
                        <div class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">é ä¼°å¹´æ¯</div>
                        <div class="text-lg font-black text-yellow-400 tracking-tight whitespace-nowrap font-num">$ <span id="totalAnnualDiv">0</span></div>
                    </div>
                    <div class="text-center p-2 bg-slate-800/50 rounded-lg border border-slate-700/50 backdrop-blur-sm">
                        <div class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">æœˆå‡è¢«å‹•</div>
                        <div class="text-lg font-black text-emerald-400 tracking-tight whitespace-nowrap font-num">$ <span id="totalMonthlyDiv">0</span></div>
                    </div>
                    <div class="text-center p-2 bg-slate-800/50 rounded-lg border border-slate-700/50 backdrop-blur-sm">
                        <div class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">ç¸½æ®–åˆ©ç‡</div>
                        <div class="text-lg font-black text-rose-400 tracking-tight whitespace-nowrap font-num"><span id="portfolioYield">0.0</span>%</div>
                    </div>
                </div>
                
                <div class="btn-toolbar-group screenshot-hide">
                    <button onclick="toggleMasterLabelPos()" class="btn-icon w-8 h-8 rounded-full font-bold text-lg" title="åˆ‡æ› å…§/å¤–">â—</button>
                    <button onclick="downloadMasterChart()" class="btn-icon w-8 h-8 rounded-full" title="å¦é–‹é«˜ç•«è³ªåœ–æª”">ğŸ“·</button>
                </div>
                <div class="master-container"><canvas id="masterCanvas"></canvas></div>
            </div>
        </div>

        <div id="chartsWrapper" class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6"></div>

        <div id="inputArea" class="input-card shadow-2xl hidden-in-view-mode">
            <input type="hidden" id="editId" value="">
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3 mb-4">
                <div class="col-span-1"><label class="text-[10px] text-slate-400 mb-1 block font-medium">è‚¡ç¥¨ä»£è™Ÿ (é™æ•¸å­—)</label><input id="symbol" class="input-field font-bold tracking-wide font-num" placeholder="ä¾‹å¦‚ 2330"></div>
                <div class="col-span-1"><label class="text-[10px] text-blue-400 mb-1 block font-medium">æ–‡å­—å¤§å°</label><input type="number" id="fontSize" class="input-field font-num" value="12"></div>
                <div class="col-span-1"><label class="text-[10px] text-slate-400 mb-1 block font-medium">å¼µæ•¸</label><input type="number" id="shares" class="input-field font-num" step="0.001"></div>
                <div class="col-span-1"><label class="text-[10px] text-slate-400 mb-1 block font-medium">è²·å…¥å‡åƒ¹</label><input type="number" id="avgPrice" class="input-field font-num"></div>
                <div class="col-span-1"><label class="text-[10px] text-amber-400 mb-1 block font-medium">ç›®å‰è‚¡åƒ¹</label><input type="number" id="currentPrice" class="input-field font-num" placeholder="è‡ªå‹•æŠ“å–"></div>
                <div class="col-span-1"><label class="text-[10px] text-yellow-400 mb-1 block font-medium">é…æ¯é »ç‡</label><select id="divFreq" class="input-field"><option value="1">å¹´é… (1æ¬¡/å¹´)</option><option value="2">åŠå¹´é… (2æ¬¡/å¹´)</option><option value="4">å­£é… (4æ¬¡/å¹´)</option><option value="12">æœˆé… (12æ¬¡/å¹´)</option><option value="0">ç„¡é…æ¯</option></select></div>
                <div class="col-span-1">
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-[10px] text-yellow-400 font-medium">å–®æ¬¡é…æ¯</label>
                        <label class="flex items-center cursor-pointer gap-1" title="è‹¥å–æ¶ˆå‹¾é¸ï¼Œæ­¤ç­†é…æ¯åªæœƒç®—åœ¨å¹´ç¸½é¡ï¼Œä¸åˆ—å…¥æœˆå¹³å‡è¨ˆç®—">
                            <input type="checkbox" id="includeInMonthly" class="accent-blue-500 w-3 h-3 cursor-pointer" checked>
                            <span class="text-[9px] text-slate-400 select-none font-medium">ä½µæœˆå‡</span>
                        </label>
                    </div>
                    <input type="number" id="divAmt" class="input-field font-num" placeholder="æ¯è‚¡é‡‘é¡" step="0.01">
                </div>
                <div class="col-span-1"><label class="text-[10px] text-emerald-400 mb-1 block font-medium">å·²é ˜æ¯(ç¸½é¡)</label><input type="number" id="divRec" value="0" class="input-field font-num"></div>
                <div class="col-span-1"><label class="text-[10px] text-orange-400 mb-1 block font-medium">å·²ç²åˆ©(ç¸½é¡)</label><input type="number" id="gainRec" value="0" class="input-field font-num"></div>
                <div class="col-span-2 md:col-span-4 lg:col-span-7"><label class="text-[10px] text-yellow-500 mb-1 block font-medium">ä¸­æ–‡åç¨± / å‚™è¨»</label><input id="note" class="input-field" placeholder="ä¾‹å¦‚ å°ç©é›»"></div>
            </div>
            <button onclick="saveStock()" class="w-full bg-blue-600 py-4 rounded-xl font-black text-xl active:scale-95 transition-all tracking-widest shadow-lg">å„²å­˜ä¸¦åˆ·æ–°</button>
        </div>

        <div id="listHeader" class="flex justify-between items-center mb-4 px-1 hidden-in-view-mode">
            <span class="text-sm font-bold text-slate-500 uppercase tracking-widest">è³‡ç”¢åˆ—è¡¨</span>
            <button id="sortToggle" onclick="toggleSortMode()" class="text-xs bg-slate-800 border border-slate-600 px-5 py-2 rounded-full text-blue-400 font-bold tracking-wide">â‡… æ’åº</button>
        </div>

        <div id="mainTable" class="space-y-2 pb-24 hidden-in-view-mode"></div>
    </div>
    
    <footer class="text-center text-slate-600 text-[10px] mt-8 py-6 border-t border-slate-800 tracking-wider font-medium">
        Copyright Â© Titleman
    </footer>
    
    <script>
        const VERCEL_URL = "https://my-stock-api-blond.vercel.app"; 
        const RENDER_URL = "https://my-stock-api-g3bz.onrender.com";

        function loadRobustData(currentKey, fallbackKeys, defaultValue) {
            let data = localStorage.getItem(currentKey);
            if (data && data !== "[]" && data !== "null") return JSON.parse(data);
            for (let key of fallbackKeys) {
                let oldData = localStorage.getItem(key);
                if (oldData && oldData !== "[]" && oldData !== "null") {
                    localStorage.setItem(currentKey, oldData);
                    return JSON.parse(oldData);
                }
            }
            return defaultValue;
        }

        const assetKeys = ['myAssetsV112', 'myAssetsV111', 'myAssetsV110']; 
        const configKeys = ['chartConfigsV112', 'chartConfigsV111', 'chartConfigsV110'];

        let myAssets = loadRobustData('myAssetsV112', assetKeys, []);
        let chartConfigs = loadRobustData('chartConfigsV112', configKeys, [{ id: Date.now(), title: 'ä¸»è¦é…ç½®', selectedIds: [], labelPos: 'inside', labelContent: 'symbol' }]);
        
        chartConfigs.forEach(c => { 
            if (!c.selectedIds) c.selectedIds = [];
            if (!c.labelPos || c.labelPos === 'outside') c.labelPos = 'inside'; // å¼·åˆ¶é è¨­ inside
            if (!c.labelContent) c.labelContent = 'symbol'; 
        });
        myAssets.forEach(a => { if(typeof a.currentPrice === 'undefined') a.currentPrice = 0; });

        let masterLabelPos = localStorage.getItem('masterLabelPosV1') || 'inside'; 
        let currentTheme = localStorage.getItem('appThemeV1') || 'dark';
        let isEditMode = localStorage.getItem('editModeV1') !== 'false';
        
        let chartInstances = {};
        let masterChartInstance = null;
        let isSortMode = false;
        let sortable = null;

        const uniquePalette = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316', '#14b8a6', '#fbbf24', '#6366f1', '#d946ef', '#2dd4bf', '#f43f5e', '#a855f7', '#34d399', '#fb7185', '#60a5fa', '#fb923c', '#818cf8'];
        function getItemColor(index) { return uniquePalette[index % uniquePalette.length]; }
        function getThemeColor(varName) { return getComputedStyle(document.documentElement).getPropertyValue(varName).trim(); }

        async function fetchRace(endpoint) {
            const controller = new AbortController();
            const signal = controller.signal;
            const vercelPromise = fetch(`${VERCEL_URL}${endpoint}`, { signal }).then(res => { if (!res.ok) throw new Error("Vercel error"); return res.json(); });
            const startRender = () => fetch(`${RENDER_URL}${endpoint}`, { signal }).then(res => { if (!res.ok) throw new Error("Render error"); return res.json(); });
            const delayedRenderPromise = new Promise((resolve, reject) => {
                setTimeout(() => { startRender().then(resolve).catch(reject); }, 1500); 
            });
            try { return await Promise.any([vercelPromise, delayedRenderPromise]); } 
            catch (error) { return await startRender(); }
        }

        async function updateAllPrices() {
            const btn = document.getElementById('loadingOverlay');
            const txt = document.getElementById('loadingText');
            btn.style.display = 'flex';
            txt.innerText = "æ­£åœ¨é€£ç·šä¼ºæœå™¨ï¼Œå¯èƒ½éœ€è¦ 30-60 ç§’ (è‹¥ Render æ­£åœ¨å–šé†’)...";
            
            let updatedCount = 0;
            const uniqueSymbols = [...new Set(myAssets.map(a => a.symbol))];
            
            for (let i = 0; i < uniqueSymbols.length; i++) {
                const sym = uniqueSymbols[i];
                if(!sym || isNaN(sym)) continue; 
                txt.innerText = `æ›´æ–°ä¸­ (${i+1}/${uniqueSymbols.length}): ${sym}`;
                try {
                    const data = await fetchRace(`/dividend/${sym}`);
                    if (data && data.price) {
                        myAssets.filter(a => a.symbol === sym).forEach(a => {
                            a.currentPrice = data.price;
                        });
                        updatedCount++;
                    }
                } catch (e) {
                    console.error(`Failed to update ${sym}`, e);
                }
            }
            
            btn.style.display = 'none';
            render();
            alert(`æ›´æ–°å®Œæˆï¼å…±æ›´æ–° ${updatedCount} æª”è‚¡ç¥¨ç¾åƒ¹ã€‚\n(å¦‚æœå¤±æ•—è«‹æª¢æŸ¥ä»£è™Ÿæ˜¯å¦ç‚ºç´”æ•¸å­—)`);
        }

        // --- å¼·åŠ›é‚„åŸå‡½å¼ ---
        function openImportModal() { document.getElementById('importModal').style.display = 'flex'; }
        function closeImportModal() { document.getElementById('importModal').style.display = 'none'; document.getElementById('importTextarea').value = ''; }
        function confirmImport() {
            let c = document.getElementById('importTextarea').value;
            // è‡ªå‹•ä¿®å¾©ï¼šç§»é™¤ç©ºç™½ã€æ›è¡Œ
            c = c.replace(/\s/g, ''); 
            if(c) { 
                try { 
                    const d = JSON.parse(decodeURIComponent(atob(c))); 
                    myAssets=d.myAssets; 
                    chartConfigs=d.chartConfigs; 
                    render(); 
                    closeImportModal();
                    alert("âœ… é‚„åŸæˆåŠŸï¼");
                } catch(e){ 
                    console.error(e);
                    // å˜—è©¦æ™ºæ…§ä¿®å¾©ï¼šè£œé½Š = è™Ÿ
                    try {
                        const padded = c.padEnd(c.length + (4 - c.length % 4) % 4, '=');
                        const d = JSON.parse(decodeURIComponent(atob(padded)));
                        myAssets=d.myAssets; 
                        chartConfigs=d.chartConfigs; 
                        render();
                        closeImportModal();
                        alert("âœ… é‚„åŸæˆåŠŸ (å·²è‡ªå‹•ä¿®å¾©æ ¼å¼)ï¼");
                    } catch(e2) {
                        alert("âŒ é‚„åŸå¤±æ•—ï¼šä»£ç¢¼æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªæ‚¨å·²è¤‡è£½å®Œæ•´ä»£ç¢¼ã€‚"); 
                    }
                } 
            }
        }
        function importFromText() { openImportModal(); } 

        const techLabelsPlugin = {
            id: 'techLabels',
            afterDatasetsDraw(chart, args, options) {
               // æ­¤æ’ä»¶åƒ…åœ¨ outside æ¨¡å¼ä¸‹ç¹ªè£½ï¼Œä½†ç¾åœ¨é è¨­ insideï¼Œæ‰€ä»¥é€™è£¡é€šå¸¸ä¸æœƒåŸ·è¡Œåˆ°
               // ä¿ç•™ä»£ç¢¼ä»¥é˜²ä½¿ç”¨è€…æ‰‹å‹•åˆ‡æ›åˆ° outside
               const { ctx, chartArea: { top, bottom, left, right, width, height } } = chart;
                const lineColor = getThemeColor('--tech-line');
                const pctColor = getThemeColor('--tech-text-pct');
                const textColor = getThemeColor('--text-main');
                const isMobile = window.innerWidth < 480;

                let labels = [];
                chart.data.datasets.forEach((dataset, i) => {
                    const meta = chart.getDatasetMeta(i);
                    meta.data.forEach((datapoint, index) => {
                        const { x, y } = datapoint.tooltipPosition();
                        const model = datapoint;
                        const angle = (model.startAngle + model.endAngle) / 2;
                        const isRight = angle < Math.PI / 2 || angle > Math.PI * 1.5;
                        const outerRadius = model.outerRadius;
                        const lineExtendLen = isMobile ? 10 : 30;
                        const startX = model.x + Math.cos(angle) * outerRadius;
                        const startY = model.y + Math.sin(angle) * outerRadius;
                        const elbowX = model.x + Math.cos(angle) * (outerRadius + lineExtendLen);
                        const elbowY = model.y + Math.sin(angle) * (outerRadius + lineExtendLen);

                        labels.push({
                            index, isRight, startX, startY, elbowX, elbowY, angle,
                            text: chart.data.labels[index],
                            pct: ((dataset.data[index] / dataset.data.reduce((a,b)=>a+b,0)) * 100).toFixed(1) + '%',
                            finalY: elbowY 
                        });
                    });
                });

                ['left', 'right'].forEach(side => {
                    const isRightSide = (side === 'right');
                    const sideLabels = labels.filter(l => l.isRight === isRightSide).sort((a, b) => a.finalY - b.finalY);
                    if (sideLabels.length === 0) return;
                    const minSpacing = isMobile ? 40 : 55; 
                    for (let i = 1; i < sideLabels.length; i++) {
                        const prev = sideLabels[i-1];
                        const curr = sideLabels[i];
                        if (curr.finalY - prev.finalY < minSpacing) {
                            curr.finalY = prev.finalY + minSpacing;
                        }
                    }
                    const last = sideLabels[sideLabels.length - 1];
                    const bottomLimit = bottom + (isMobile ? 20 : 10);
                    if (last.finalY > bottomLimit) {
                        const offset = last.finalY - bottomLimit;
                        sideLabels.forEach(l => l.finalY -= offset);
                    }
                    const first = sideLabels[0];
                    const topLimit = top - (isMobile ? 20 : 10);
                    if (first.finalY < topLimit) {
                         const offset = topLimit - first.finalY;
                         sideLabels.forEach(l => l.finalY += offset);
                    }
                });

                labels.forEach(l => {
                    const lineBendLen = isMobile ? 10 : 40;
                    const endX = l.elbowX + (l.isRight ? lineBendLen : -lineBendLen);
                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(l.startX, l.startY);
                    ctx.lineTo(l.elbowX, l.elbowY);
                    ctx.lineTo(l.elbowX, l.finalY);
                    ctx.lineTo(endX, l.finalY);
                    ctx.strokeStyle = lineColor; 
                    ctx.lineWidth = 1.5;
                    ctx.shadowColor = lineColor;
                    ctx.shadowBlur = 10; 
                    ctx.stroke();
                    ctx.restore();

                    ctx.save();
                    ctx.font = isMobile ? '700 10px "Noto Sans TC", sans-serif' : '700 13px "Noto Sans TC", sans-serif';
                    ctx.fillStyle = textColor; 
                    ctx.textAlign = l.isRight ? 'left' : 'right';
                    ctx.textBaseline = 'middle';
                    ctx.shadowColor = 'rgba(0,0,0,0.8)';
                    ctx.shadowBlur = 4;
                    const textPadding = 8;
                    ctx.fillText(l.text, endX + (l.isRight ? textPadding : -textPadding), l.finalY - 8);
                    ctx.font = isMobile ? '500 9px "Roboto", sans-serif' : '500 12px "Roboto", sans-serif';
                    ctx.fillStyle = pctColor;
                    ctx.fillText(l.pct, endX + (l.isRight ? textPadding : -textPadding), l.finalY + 8);
                    ctx.restore();
                });
            }
        };

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const names = { 'dark': 'é è¨­', 'oled': 'é»‘', 'tiffany': 'è—', 'green': 'ç¶ ', 'yellow': 'é»ƒ', 'orange': 'æ©™', 'purple': 'ç´«' };
            document.getElementById('themeName').innerText = names[theme] || 'é è¨­';
            localStorage.setItem('appThemeV1', theme);
            currentTheme = theme;
            render(); 
        }

        function cycleTheme() {
            const order = ['dark', 'oled', 'tiffany', 'green', 'yellow', 'orange', 'purple'];
            const nextIndex = (order.indexOf(currentTheme) + 1) % order.length;
            applyTheme(order[nextIndex]);
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            localStorage.setItem('editModeV1', isEditMode);
            applyEditMode();
            render(); 
        }

        function applyEditMode() {
            const btn = document.getElementById('modeBtn');
            if (isEditMode) {
                document.body.classList.remove('view-mode-active');
                btn.innerHTML = 'è¿”å›';
                btn.classList.replace('text-white', 'text-blue-200');
            } else {
                document.body.classList.add('view-mode-active');
                btn.innerHTML = 'ç·¨è¼¯';
                btn.classList.replace('text-blue-200', 'text-white');
            }
        }

        // é»æ“Šåœ–è¡¨åˆ‡æ›é¡¯ç¤ºå…§å®¹ (ä½¿ç”¨ setTimeout è§£æ±ºè¡çª)
        function toggleChartLabelContent(index) {
            setTimeout(() => {
                const current = chartConfigs[index].labelContent || 'symbol';
                chartConfigs[index].labelContent = (current === 'symbol') ? 'note' : 'symbol';
                render();
            }, 50);
        }

        function render() {
            localStorage.setItem('myAssetsV112', JSON.stringify(myAssets));
            localStorage.setItem('chartConfigsV112', JSON.stringify(chartConfigs));
            localStorage.setItem('masterLabelPosV1', masterLabelPos);

            if(!document.documentElement.getAttribute('data-theme')) applyTheme(currentTheme);
            applyEditMode(); 

            // âš ï¸ é‡è¦ä¿®å¾©ï¼šé‡ç¹ªå‰å…ˆéŠ·æ¯€æ‰€æœ‰èˆŠåœ–è¡¨
            if (masterChartInstance) { masterChartInstance.destroy(); masterChartInstance = null; }
            Object.values(chartInstances).forEach(chart => chart.destroy());
            chartInstances = {};

            const chartBorderColor = getThemeColor('--chart-border');
            const textColor = getThemeColor('--text-main');
            const isMobile = window.innerWidth < 480;

            let grandTotal = 0;
            let grandTotalCost = 0; 
            let grandTotalAnnualDiv = 0;
            let grandTotalMonthlyDiv = 0;

            chartConfigs.forEach((conf) => {
                conf.selectedIds.forEach(sid => {
                    const s = myAssets.find(a => a.id == sid);
                    if(s) {
                        const netCost = (s.avgPrice * s.shares * 1000) - (s.divRec || 0) - (s.gainRec || 0);
                        grandTotal += (netCost > 0 ? netCost : 0);
                        
                        const freq = parseInt(s.divFreq) || 0;
                        const amt = parseFloat(s.divAmt) || 0;
                        const shares = parseFloat(s.shares) || 0;
                        const avgPrice = parseFloat(s.avgPrice) || 0;
                        const includeInMonthly = (s.includeInMonthly !== false); 
                        
                        grandTotalCost += (shares * 1000 * avgPrice);
                        if(freq > 0 && amt > 0 && shares > 0) {
                            let annual = shares * 1000 * amt * freq;
                            grandTotalAnnualDiv += annual;
                            if(includeInMonthly) grandTotalMonthlyDiv += (annual / 12);
                        }
                    }
                });
            });

            document.getElementById('grandTotal').innerText = (grandTotal / 10000).toFixed(1);
            let totalYieldPct = grandTotalCost > 0 ? (grandTotalAnnualDiv / grandTotalCost * 100) : 0;
            document.getElementById('totalAnnualDiv').innerText = Math.round(grandTotalAnnualDiv).toLocaleString();
            document.getElementById('totalMonthlyDiv').innerText = Math.round(grandTotalMonthlyDiv).toLocaleString();
            document.getElementById('portfolioYield').innerText = totalYieldPct.toFixed(2);

            const masterLabels = [];
            const masterData = [];
            const masterColors = [];
            let chartsHTML = '';
            
            chartConfigs.forEach((conf, i) => {
                let groupTotal = 0;
                let groupAnnualDiv = 0;
                let groupCostBasis = 0;
                let legendItems = '';

                conf.selectedIds.forEach(sid => {
                    const a = myAssets.find(item => item.id == sid);
                    if (a) {
                        const cost = (a.avgPrice * a.shares * 1000) - (a.divRec || 0) - (a.gainRec || 0);
                        groupTotal += (cost > 0 ? cost : 0);

                        const freq = parseInt(a.divFreq) || 0;
                        const amt = parseFloat(a.divAmt) || 0;
                        const shares = parseFloat(a.shares) || 0;
                        const avgPrice = parseFloat(a.avgPrice) || 0;
                        
                        if(freq > 0 && amt > 0 && shares > 0) {
                            groupAnnualDiv += (shares * 1000 * amt * freq);
                        }
                        groupCostBasis += (shares * 1000 * avgPrice);

                        const stockColor = getItemColor(myAssets.findIndex(ma => ma.id == sid));
                        const noteText = a.note ? a.note : '-';
                        legendItems += `
                            <div class="flex items-center justify-between text-xs py-1.5 border-b border-slate-700/30">
                                <div class="flex items-center gap-2">
                                    <div class="w-2 h-2 rounded-full" style="background-color: ${stockColor}"></div>
                                    <span class="font-bold text-slate-300 font-num">${a.symbol}</span>
                                </div>
                                <span class="text-slate-400 font-medium">${noteText}</span>
                            </div>
                        `;
                    }
                });

                if(groupTotal > 0) {
                    masterLabels.push(conf.title);
                    masterData.push(groupTotal);
                    masterColors.push(getItemColor(i)); 
                }

                const totalWan = (groupTotal / 10000).toFixed(1);
                let groupYield = groupCostBasis > 0 ? (groupAnnualDiv / groupCostBasis * 100).toFixed(2) : '0.00';
                const headerColorStyle = `color: ${getItemColor(i)}`;
                let headerHtml = isEditMode 
                    ? `<input type="text" onchange="chartConfigs[${i}].title=this.value;render()" value="${conf.title}" class="title-input font-black text-center w-full mb-1 text-xl" style="font-family:'Noto Sans TC'; ${headerColorStyle}">`
                    : `<h3 class="font-black text-center w-full mb-1 text-xl tracking-wide" style="font-family:'Noto Sans TC'; ${headerColorStyle}">${conf.title}</h3>`;

                chartsHTML += `
                    <div class="chart-box" id="chart-box-${i}">
                        <div class="btn-toolbar-group screenshot-hide">
                            <button onclick="toggleChartLabelPos(${i})" class="btn-icon w-8 h-8 rounded-full font-bold text-lg" title="åˆ‡æ›ä½ç½®ï¼šå…§/å¤–">â—</button>
                            <button onclick="downloadChart(${i})" class="btn-icon w-8 h-8 rounded-full" title="å¦é–‹é«˜ç•«è³ªåœ–æª”">ğŸ“·</button>
                        </div>
                        <button onclick="deleteChart(${i})" class="screenshot-hide btn-delete-pos btn-icon w-8 h-8 rounded-full flex items-center justify-center text-sm" title="åˆªé™¤åˆ†çµ„">âœ•</button>

                        ${headerHtml}
                        <div class="text-center text-slate-500 text-xs mb-2 font-mono tracking-wider font-medium">
                            å¸‚å€¼ï¼š<span class="text-emerald-400 font-black text-base font-num">${totalWan}</span> è¬
                        </div>
                        <div class="flex justify-center gap-3 mb-3">
                            <div class="px-3 py-2 bg-slate-800/50 rounded border border-slate-700/30">
                                <span class="text-slate-400 block text-xs mb-1">é ä¼°å¹´æ¯</span>
                                <span class="text-yellow-400 font-black text-xl font-num">$${Math.round(groupAnnualDiv).toLocaleString()}</span>
                            </div>
                             <div class="px-3 py-2 bg-slate-800/50 rounded border border-slate-700/30">
                                <span class="text-slate-400 block text-xs mb-1">æ®–åˆ©ç‡</span>
                                <span class="text-rose-400 font-black text-xl font-num">${groupYield}%</span>
                            </div>
                        </div>
                        
                        <div class="chart-container" onclick="toggleChartLabelContent(${i})" title="é»æ“Šåœ–è¡¨åˆ‡æ›é¡¯ç¤º ä»£è™Ÿ / åç¨±"><canvas id="canvas-${i}"></canvas></div>
                        
                        <div class="show-in-view-mode mt-4 px-2 bg-slate-800/20 rounded-lg">
                            ${legendItems || '<div class="text-xs text-slate-600 text-center py-2">ç„¡è³‡æ–™</div>'}
                        </div>
                    </div>`;
            });

            document.getElementById('chartsWrapper').innerHTML = chartsHTML;

            const masterWrapper = document.getElementById('masterChartWrapper');
            if(grandTotal > 0) {
                masterWrapper.classList.remove('hidden');
                const ctxM = document.getElementById('masterCanvas').getContext('2d');
                masterChartInstance = new Chart(ctxM, {
                    type: 'pie',
                    data: { labels: masterLabels, datasets: [{ data: masterData, backgroundColor: masterColors, borderWidth: 2, borderColor: chartBorderColor }]},
                    options: {
                        devicePixelRatio: 3, responsive: true, maintainAspectRatio: false, 
                        radius: isMobile ? '50%' : '90%', 
                        layout: { padding: (masterLabelPos === 'outside') ? { top: 50, bottom: 20, left: 20, right: 20 } : { top: 50, bottom: 20, left: 20, right: 20 } },
                        plugins: {
                            legend: { display: (masterLabelPos === 'inside'), position: 'bottom', labels: { color: textColor, font: { size: 12, family: '"Noto Sans TC", sans-serif' }, padding: 15 } },
                            datalabels: { display: (masterLabelPos === 'inside'), color: (ctx) => '#ffffff', textAlign: 'center', font: { weight: 'bold', size: 13, family: '"Noto Sans TC", sans-serif' }, formatter: (val, ctx) => ((val / grandTotal) * 100).toFixed(1) + '%' }
                        }
                    },
                    plugins: (masterLabelPos === 'outside') ? [techLabelsPlugin] : []
                });
            } else {
                masterWrapper.classList.add('hidden');
            }

            updateCharts();
            renderAssetList();
        }

        function renderAssetList() {
            const body = document.getElementById('mainTable');
            let listHTML = '';
            myAssets.forEach((item, index) => {
                const stockColor = getItemColor(index);
                let btns = '';
                chartConfigs.forEach((c, ci) => {
                    const active = c.selectedIds.includes(parseInt(item.id));
                    const style = active ? `background:${stockColor}; border-color:${stockColor}; color:white;` : `background:var(--row-border); border-color:var(--border-color); color:var(--text-sub);`;
                    btns += `<div onclick="event.stopPropagation(); toggleToChart(${item.id}, ${ci})" style="${style}" class="num-dot font-medium">${ci+1}</div>`;
                });

                const freq = parseInt(item.divFreq) || 0;
                const amt = parseFloat(item.divAmt) || 0;
                const shares = parseFloat(item.shares) || 0;
                const avgPrice = parseFloat(item.avgPrice) || 0;
                const divRec = parseFloat(item.divRec) || 0;
                const gainRec = parseFloat(item.gainRec) || 0;
                const currentPrice = parseFloat(item.currentPrice) || 0;
                
                const totalCost = shares * 1000 * avgPrice;
                const netCostValue = totalCost - divRec - gainRec; 
                const netCostPerShare = shares > 0 ? (netCostValue / (shares * 1000)) : 0; 
                
                let plHtml = '';
                if(currentPrice > 0 && shares > 0) {
                    const unrealizedPL = (currentPrice - netCostPerShare) * shares * 1000;
                    const plClass = unrealizedPL >= 0 ? 'text-gain' : 'text-loss';
                    const plSign = unrealizedPL >= 0 ? '+' : '';
                    
                    plHtml = `
                        <div class="flex justify-between items-center text-xs mt-2 border-t border-slate-700/50 pt-1.5">
                            <span class="text-slate-400">ç¾åƒ¹ <span class="text-white font-bold ml-1 font-num">${currentPrice}</span></span>
                            <span class="text-slate-400" title="æ·¨æˆæœ¬ = (ç¸½æˆæœ¬ - é ˜æ¯ - ç²åˆ©) / è‚¡æ•¸">æ·¨æœ¬ <span class="text-slate-200 font-bold ml-1 font-num">${netCostPerShare.toFixed(2)}</span></span>
                            <span class="${plClass} font-bold ml-2 text-sm font-num">${plSign}${(unrealizedPL/10000).toFixed(2)}è¬</span>
                        </div>
                    `;
                } else {
                     plHtml = `
                        <div class="flex justify-between items-center text-xs mt-2 border-t border-slate-700/50 pt-1.5">
                            <span class="text-slate-500">ç­‰å¾…æ›´æ–°è‚¡åƒ¹...</span>
                        </div>
                    `;
                }

                let estAnnual = 0;
                if (freq > 0 && amt > 0 && shares > 0) {
                    estAnnual = shares * 1000 * amt * freq;
                }

                listHTML += `
                    <div class="compact-row" data-id="${item.id}">
                        <div class="drag-handle">â˜°</div>
                        <div class="w-1.5 h-7 rounded-full mr-3" style="background:${stockColor}"></div>
                        <div class="flex-1 text-sm min-w-[140px]">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="font-bold text-[15px] tracking-wide text-white">${item.symbol}</span>
                                    ${item.note ? `<span class="stock-name-display">${item.note}</span>` : ''}
                                    <span class="text-slate-500 text-xs ml-2 font-medium font-num">${item.shares}å¼µ</span>
                                </div>
                                <span class="text-[10px] text-yellow-500 bg-yellow-900/20 px-1.5 py-0.5 rounded font-medium ml-2 whitespace-nowrap font-num">æ¯ $${Math.round(estAnnual).toLocaleString()}</span>
                            </div>
                            ${plHtml}
                        </div>
                        <div class="flex gap-1 ml-2">${btns}</div>
                        <div class="flex gap-4 ml-4">
                            <span onclick="editItem(${item.id})" class="text-blue-500 font-bold text-xs cursor-pointer">æ”¹</span>
                            <span onclick="deleteItem(${item.id})" class="text-slate-700 text-xs cursor-pointer">âœ•</span>
                        </div>
                    </div>`;
            });
            body.innerHTML = listHTML;
            if(isSortMode) initSortable();
        }

        function updateCharts() {
            const chartBorderColor = getThemeColor('--chart-border');
            chartConfigs.forEach((conf, i) => {
                const canvas = document.getElementById(`canvas-${i}`);
                if(!canvas) return;
                const ctx = canvas.getContext('2d');
                const dData = [], dLabels = [], dColors = [], dShares = [], dFontSizes = [];
                conf.selectedIds.forEach(sid => {
                    const idx = myAssets.findIndex(a => a.id == sid);
                    if(idx !== -1) {
                        const s = myAssets[idx];
                        const netCost = (s.avgPrice * s.shares * 1000) - (s.divRec || 0) - (s.gainRec || 0);
                        dData.push(netCost > 0 ? netCost : 1);
                        
                        let labelText = s.symbol;
                        // åˆ¤å®šé¡¯ç¤ºæ–‡å­—ï¼šå¦‚æœæ˜¯ note æ¨¡å¼ä¸”æœ‰å¡«å¯« noteï¼Œå°±é¡¯ç¤ºä¸­æ–‡
                        if (conf.labelContent === 'note' && s.note) {
                            labelText = s.note;
                        }
                        
                        dLabels.push(labelText);
                        dShares.push(s.shares); 
                        dColors.push(getItemColor(idx)); 
                        dFontSizes.push(s.fontSize || 12);
                    }
                });
                
                const currentPos = conf.labelPos || 'inside'; 
                
                chartInstances[i] = new Chart(ctx, {
                    type: 'pie',
                    data: { labels: dLabels, datasets: [{ data: dData, backgroundColor: dColors, borderWidth: 1, borderColor: chartBorderColor }]},
                    options: {
                        // é‡è¦ï¼šç§»é™¤ Chart.js é è¨­çš„ onClickï¼Œæ”¹ç”±å¤–å±¤ div è™•ç†ï¼Œé¿å…è¡çª
                        onClick: null, 
                        devicePixelRatio: 3, responsive: true, maintainAspectRatio: false, 
                        radius: isMobile ? '50%' : '90%', 
                        layout: { padding: (currentPos === 'outside') ? (window.innerWidth < 480 ? 60 : 40) : 20 },
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                color: (ctx) => '#ffffff', textAlign: 'center', display: true, anchor: currentPos === 'outside' ? 'end' : 'center', align: currentPos === 'outside' ? 'end' : 'center', offset: currentPos === 'outside' ? 4 : 0, font: (ctx) => ({ weight: 'bold', size: dFontSizes[ctx.dataIndex], family: '"Noto Sans TC", sans-serif' }), formatter: (val, ctx) => ctx.chart.data.labels[ctx.dataIndex] + '\n' + dShares[ctx.dataIndex] + 'å¼µ'
                            }
                        }
                    },
                    plugins: (masterLabelPos === 'outside') ? [techLabelsPlugin] : []
                });
            });
        }

        function toggleToChart(sid, ci) { 
            if (!chartConfigs[ci]) return;
            if (!chartConfigs[ci].selectedIds) chartConfigs[ci].selectedIds = [];
            const arr = chartConfigs[ci].selectedIds;
            const id = parseInt(sid);
            const i = arr.indexOf(id); 
            if (i > -1) arr.splice(i, 1); 
            else arr.push(id); 
            render(); 
        }

        function toggleMasterLabelPos() { masterLabelPos = (masterLabelPos === 'outside') ? 'inside' : 'outside'; render(); }
        function toggleChartLabelPos(index) { const current = chartConfigs[index].labelPos || 'inside'; chartConfigs[index].labelPos = (current === 'outside') ? 'inside' : 'outside'; render(); }
        
        function downloadMasterChart() { const el = document.getElementById('masterChartBox'); const total = document.getElementById('grandTotal').innerText; captureAndOpenImage(el, `è³‡ç”¢ç¸½è¦½_ç¸½å€¼${total}è¬`); }
        function downloadChart(index) { const el = document.getElementById(`chart-box-${index}`); const title = chartConfigs[index].title || 'chart'; const val = (el.innerText.match(/å¸‚å€¼ï¼š([\d\.]+) è¬/) || [])[1] || ''; captureAndOpenImage(el, `${title}_å¸‚å€¼${val}è¬`); }

        function captureAndOpenImage(element, fileName) {
            const loading = document.getElementById('loadingOverlay'); loading.style.display = 'flex'; element.classList.add('capturing'); const originalBg = element.style.backgroundColor; element.style.backgroundColor = getThemeColor('--bg-card');
            setTimeout(() => {
                html2canvas(element, { 
                    scale: 5, 
                    backgroundColor: getThemeColor('--bg-card'), 
                    useCORS: true, 
                    logging: false, 
                    allowTaint: true, 
                    onclone: (clonedDoc) => {
                        const clonedEl = clonedDoc.getElementById(element.id);
                        if (clonedEl) {
                            clonedEl.style.transform = 'none';
                            const input = clonedEl.querySelector('input.title-input');
                            if (input) {
                                const h3 = clonedDoc.createElement('h3');
                                h3.textContent = input.value;
                                h3.className = "font-black text-center w-full mb-1 text-xl tracking-wide";
                                h3.style.fontFamily = "'Noto Sans TC'";
                                h3.style.color = input.style.color;
                                h3.style.display = 'flex';
                                h3.style.justifyContent = 'center';
                                h3.style.alignItems = 'center';
                                h3.style.margin = '0 auto 4px auto'; 
                                input.replaceWith(h3);
                            }
                        }
                    }
                }).then(canvas => {
                    loading.style.display = 'none'; element.classList.remove('capturing'); element.style.backgroundColor = originalBg; 
                    const jpgUrl = canvas.toDataURL('image/jpeg', 1.0); const newWin = window.open('', '_blank');
                    if (newWin) { newWin.document.write(`<html><head><title>${fileName}</title><style>body{margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background-color:#111}img{max-width:95%;height:auto;box-shadow:0 0 20px rgba(0,0,0,0.5);border-radius:12px}.tip{position:fixed;top:10px;left:50%;transform:translateX(-50%);color:#fff;background:rgba(0,0,0,0.7);padding:8px 16px;border-radius:20px;font-family:sans-serif;font-size:14px}</style></head><body><div class="tip">è«‹é•·æŒ‰åœ–ç‰‡æˆ–å³éµå¦å­˜</div><img src="${jpgUrl}"></body></html>`); newWin.document.close(); } else { alert('è«‹å…è¨±å½ˆå‡ºè¦–çª—'); }
                }).catch(err => { console.error(err); loading.style.display = 'none'; element.classList.remove('capturing'); element.style.backgroundColor = originalBg; alert("å¤±æ•—"); });
            }, 100);
        }

        function copyToClipboard() { const d = btoa(encodeURIComponent(JSON.stringify({myAssets, chartConfigs}))); const textArea = document.createElement("textarea"); textArea.value = d; textArea.style.position = "fixed"; textArea.style.left = "-9999px"; textArea.style.top = "0"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { const successful = document.execCommand('copy'); if ( successful) alert("å‚™ä»½å·²è¤‡è£½ï¼"); else prompt("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ä»£ç¢¼ï¼š", d); } catch (err) { console.error('Fallback', err); prompt("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ä»£ç¢¼ï¼š", d); } document.body.removeChild(textArea); }
        function importFromText() { const c = prompt("ä»£ç¢¼ï¼š"); if(c) { try { const d = JSON.parse(decodeURIComponent(atob(c))); myAssets=d.myAssets; chartConfigs=d.chartConfigs; render(); } catch(e){ alert("éŒ¯èª¤"); } } }
        function toggleSortMode() { isSortMode = !isSortMode; const btn = document.getElementById('sortToggle'); const table = document.getElementById('mainTable'); if(isSortMode) { btn.innerText = "âœ“ é–å®šé †åº"; table.classList.add('sort-mode-active'); initSortable(); } else { btn.innerText = "â‡… æ’åºæ¨¡å¼"; table.classList.remove('sort-mode-active'); if (sortable) sortable.destroy(); } }
        function initSortable() { const el = document.getElementById('mainTable'); if (sortable) sortable.destroy(); sortable = Sortable.create(el, { handle: '.drag-handle', animation: 200, onEnd: () => { const newOrder = Array.from(el.querySelectorAll('.compact-row')).map(r => parseInt(r.dataset.id)); myAssets = newOrder.map(id => myAssets.find(a => a.id === id)); render(); } }); }
        
        function saveStock() {
            const sym = document.getElementById('symbol').value.trim();
            if(!sym) return;
            const editId = document.getElementById('editId').value;
            const data = { 
                id: editId ? parseInt(editId) : Date.now(), 
                symbol: sym.toUpperCase(), 
                fontSize: parseInt(document.getElementById('fontSize').value) || 12, 
                shares: parseFloat(document.getElementById('shares').value) || 0, 
                avgPrice: parseFloat(document.getElementById('avgPrice').value) || 0, 
                currentPrice: parseFloat(document.getElementById('currentPrice').value) || 0,
                divRec: parseFloat(document.getElementById('divRec').value) || 0, 
                gainRec: parseFloat(document.getElementById('gainRec').value) || 0, 
                divFreq: parseInt(document.getElementById('divFreq').value) || 0,
                divAmt: parseFloat(document.getElementById('divAmt').value) || 0,
                includeInMonthly: document.getElementById('includeInMonthly').checked,
                note: document.getElementById('note').value.trim() 
            };
            if (editId) { myAssets[myAssets.findIndex(i => i.id == editId)] = data; } else { myAssets.push(data); if (chartConfigs.length > 0) { if (!chartConfigs[0].selectedIds) chartConfigs[0].selectedIds = []; chartConfigs[0].selectedIds.push(data.id); } }
            ["editId", "symbol", "shares", "avgPrice", "currentPrice", "divRec", "gainRec", "note", "divAmt"].forEach(id => document.getElementById(id).value = (id.includes('Rec') || id === 'divAmt' || id === 'currentPrice' ? 0 : ""));
            document.getElementById('fontSize').value = 12;
            document.getElementById('divFreq').value = 1; 
            document.getElementById('includeInMonthly').checked = true;
            render();
        }

        function editItem(id) {
            const item = myAssets.find(i => i.id == id);
            ["symbol", "fontSize", "shares", "avgPrice", "currentPrice", "divRec", "gainRec", "note", "divAmt", "divFreq"].forEach(k => {
                const el = document.getElementById(k);
                if(el) el.value = item[k] || (k === 'divAmt' || k.includes('Rec') || k === 'currentPrice' ? 0 : "");
            });
            document.getElementById('includeInMonthly').checked = (item.includeInMonthly !== false);
            document.getElementById('editId').value = item.id;
            document.getElementById('inputArea').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function addNewChart() { const t = prompt("çµ„åˆ¥åç¨±ï¼š"); if (t) { chartConfigs.push({ id: Date.now(), title: t, selectedIds: [], labelPos: 'outside' }); render(); } }
        function deleteChart(idx) { if (confirm("åˆªé™¤ï¼Ÿ")) { chartConfigs.splice(idx, 1); render(); } }
        function deleteItem(id) { if(confirm("åˆªé™¤ï¼Ÿ")) { myAssets = myAssets.filter(i => i.id !== id); render(); } }
        
        window.onload = () => { Chart.register(ChartDataLabels); render(); };
    </script>
</body>
</html>
